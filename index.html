<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تقييم استحقاق الأسر للمساعدات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- إضافة مكتبة Leaflet للخرائط -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #saveMessage {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 500;
            display: none;
            z-index: 1000;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .family-member-row {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #4361ee;
        }

        /* تنسيق الخريطة */
        .location-section {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
            font-weight: 600;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 15px;
            z-index: 1;
        }

        .location-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .location-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
        }

        .location-btn.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .location-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        .location-info {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            margin-top: 10px;
        }

        .location-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coordinates {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        .search-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .search-btn:hover {
            background: var(--secondary);
        }

        footer {
            max-width: 900px;
            margin: 30px auto 10px;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e4e8f0 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        footer::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4361ee 0%, #f72585 100%);
        }
        
        .footer-content {
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .launched-by {
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
            color: #4361ee;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            border-radius: 50px;
            background-color: rgba(67, 97, 238, 0.08);
            transition: all 0.3s ease;
        }
        
        .launched-by:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.15);
        }
        
        .signature {
            margin-top: 8px;
            color: #6c757d;
            font-size: 0.9rem;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .version {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #9e9e9e;
        }

        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #ef233c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            z-index: 2;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        #purchasedItemsGroup {
            display: none;
        }
        
        #providerGroup {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .fa-shopping-cart {
            color: var(--success);
        }
        
        h1 {
            color: var(--primary);
            font-size: 2.2rem;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: var(--accent);
            border-radius: 2px;
        }

        h2 {
            color: var(--secondary);
            font-size: 1.5rem;
            margin: 25px 0 15px;
            padding-right: 15px;
            border-right: 4px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: var(--primary);
            font-size: 1.2rem;
            margin: 20px 0 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-content {
            padding: 0 30px 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            position: relative;
            padding-right: 20px;
        }

        label.required::after {
            content: '*';
            color: var(--danger);
            position: absolute;
            right: 5px;
            top: 0;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background-color: rgba(255, 255, 255, 0.8);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 30px auto;
            width: fit-content;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .device-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-light);
            transition: var(--transition);
        }

        .device-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .device-count {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .device-count > div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-count input {
            width: 80px;
            text-align: center;
        }

        .damage-type-group {
            margin-top: 15px;
            padding-right: 15px;
            border-right: 2px solid #eee;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        .other-input {
            margin-top: 10px;
            animation: fadeIn 0.3s ease;
        }

        .requests-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .request-item {
            position: relative;
        }

        .request-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .request-item label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #f0f4f8;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #ddd;
            margin: 0;
            padding-right: 35px;
        }

        .request-item input[type="checkbox"]:checked + label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .request-item label::before {
            content: '';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--gray);
            border-radius: 3px;
            transition: var(--transition);
        }

        .request-item input[type="checkbox"]:checked + label::before {
            border-color: white;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234361ee'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-item {
            position: relative;
        }

        .radio-item input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-item label {
            display: inline-block;
            padding: 8px 15px 8px 30px;
            cursor: pointer;
            transition: var(--transition);
            margin: 0;
        }

        .radio-item label::before {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray);
            border-radius: 50%;
            transition: var(--transition);
        }

        .radio-item input[type="radio"]:checked + label::before {
            border-color: var(--primary);
            background-color: var(--primary);
            box-shadow: inset 0 0 0 3px white;
        }

        .result-container {
            margin-top: 40px;
            padding: 30px;
            border-radius: var(--border-radius);
            background-color: white;
            box-shadow: var(--box-shadow);
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .result-title {
            color: var(--primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rating-badge {
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .rating-badge.A {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .rating-badge.B {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .rating-badge.C {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .eligibility-status {
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.8;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .eligibility-status.eligible {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
        }

        .eligibility-status.not-eligible {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }

        .devices-list {
            margin-top: 20px;
        }

        .device-item {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .device-item:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
        }

        .device-item i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .progress-container {
            margin-top: 30px;
            background-color: #f1f3f5;
            border-radius: 50px;
            height: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 50px;
            transition: width 1s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .visual-rating {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .rating-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .rating-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                var(--primary) 0%,
                var(--accent) 100%
            );
            opacity: 0.1;
            z-index: 0;
        }

        .rating-circle.A {
            color: #28a745;
            border: 5px solid rgba(40, 167, 69, 0.3);
        }

        .rating-circle.B {
            color: #ffc107;
            border: 5px solid rgba(255, 193, 7, 0.3);
        }

        .rating-circle.C {
            color: #dc3545;
            border: 5px solid rgba(220, 53, 69, 0.3);
        }

        .rating-circle .letter {
            font-size: 2.5rem;
            line-height: 1;
            z-index: 1;
        }

        .rating-circle .text {
            font-size: 0.9rem;
            margin-top: 5px;
            z-index: 1;
        }
        
        .condition-box {
            background-color: #e9f7ef;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        
        .condition-box.not-met {
            background-color: #fbeaea;
            border-left: 4px solid #dc3545;
        }
        
        .condition-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .condition-desc {
            font-size: 0.95rem;
        }
        
        .calculation-info {
            background-color: #e7f3ff;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .calculation-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .calculation-desc {
            font-size: 0.95rem;
        }
        
        .fridge-condition {
            background-color: #e6f7ff;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #4cc9f0;
        }
        
        .fridge-condition.not-met {
            background-color: #fbeaea;
            border-left: 4px solid #dc3545;
        }
        
        .bride-rules {
            background-color: #f8f0fc;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #9c36b5;
        }
        
        .bride-rules h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #9c36b5;
            margin-bottom: 10px;
        }
        
        .bride-rules ul {
            padding-right: 20px;
        }
        
        .bride-rules li {
            margin-bottom: 8px;
        }
        
        .notes-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .notes-section h2 {
            border-right: none;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            header, .form-content {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .device-count {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .requests-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-col {
                min-width: 100%;
            }

            #map {
                height: 300px;
            }

            .location-controls {
                flex-direction: column;
            }

            .location-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hand-holding-heart"></i> نظام تقييم استحقاق الأسر والعرايس للمساعدات</h1>
            <p></p>
        </header>
        
        <div class="form-content">
            <form id="familyForm">
                <div class="form-section">
                    <h2><i class="fas fa-users"></i> بيانات الأسرة/العروسة</h2>
                    
                    <div class="form-group">
                        <label for="familyType" class="required">نوع الأسرة:</label>
                        <select id="familyType" required>
                            <option value="">-- اختر نوع الأسرة --</option>
                            <option value="married">عروسة مكتوب كتابها</option>
                            <option value="family">أسرة</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="familyName" class="required">اسم الأسرة / العروسة:</label>
                        <input type="text" id="familyName" required placeholder="أدخل اسم الأسرة أو العروسة">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="nationalId" class="required">الرقم القومي:</label>
                                <input type="text" id="nationalId" required placeholder="أدخل الرقم القومي (14 رقمًا)" 
                                       maxlength="14" pattern="\d{14}" title="يجب أن يتكون الرقم القومي من 14 رقمًا">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="phoneNumber" class="required">رقم التليفون:</label>
                                <input type="tel" id="phoneNumber" required placeholder="أدخل رقم التليفون (10 أو 11 رقمًا)" 
                                       pattern="01\d{9}" title="يجب أن يبدأ الرقم بـ 01 ويتبعه 9 أرقام">
                            </div>
                        </div>
                    </div>

                    <!-- قسم تحديد الموقع الجديد -->
                    <div class="location-section">
                        <div class="location-header">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>تحديد الموقع</span>
                        </div>
                        
                        <div class="search-container">
                            <input type="text" id="locationSearch" class="search-input" placeholder="ابحث عن موقع (مثل: القاهرة، الجيزة، الإسكندرية...)">
                            <button type="button" class="search-btn" onclick="searchLocation()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div class="location-controls">
                            <button type="button" class="location-btn" onclick="getCurrentLocation()">
                                <i class="fas fa-crosshairs"></i>
                                تحديد موقعي الحالي
                            </button>
                            <button type="button" class="location-btn secondary" onclick="resetMap()">
                                <i class="fas fa-undo"></i>
                                إعادة تعيين الخريطة
                            </button>
                        </div>

                        <div id="map"></div>

                        <div class="location-info" id="locationInfo" style="display: none;">
                            <h4><i class="fas fa-info-circle"></i> معلومات الموقع المحدد</h4>
                            <p><strong>العنوان:</strong> <span id="selectedAddress">لم يتم تحديد العنوان بعد</span></p>
                            <div class="coordinates">
                                <strong>الإحداثيات:</strong> 
                                <span id="selectedCoordinates">غير محدد</span>
                            </div>
                        </div>

                        <!-- حقول مخفية لحفظ بيانات الموقع -->
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <input type="hidden" id="fullAddress" name="fullAddress">
                    </div>

                    <div id="providerGroup" class="form-group" style="display: none;">
                        <label>هل يوجد عائل للعروسة؟</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="hasProvider" value="yes" id="providerYes">
                                <label for="providerYes">نعم</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="hasProvider" value="no" id="providerNo" checked>
                                <label for="providerNo">لا</label>
                            </div>
                        </div>
                    </div>
                    
                    

                    <div class="form-group">
    <label for="familySize" class="required">عدد أفراد الأسرة:</label>
    <input type="number" id="familySize" min="1" required placeholder="أدخل عدد الأفراد"
           onchange="generateFamilyMembersInputs()">
</div>

<!-- القسم الجديد: بيانات أفراد الأسرة -->
<div id="familyMembersGroup" class="form-group" style="display: none; margin-top: 20px;">
    <h3><i class="fas fa-user-friends"></i> بيانات أفراد الأسرة</h3>
    <p>يرجى إدخال اسم كل فرد وقرابته (مثل: أب، أم، ابن، إلخ)</p>
    <div id="familyMembersContainer">
        <!-- سيتم إنشاء حقول الإدخال ديناميكياً هنا -->
    </div>
</div>
                    
                    <div id="elderlyGroup" class="form-group" style="display:none;">
                        <label>هل يوجد مسن في الأسرة؟</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="hasElderly" value="yes" id="elderlyYes">
                                <label for="elderlyYes">نعم</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="hasElderly" value="no" id="elderlyNo" checked>
                                <label for="elderlyNo">لا</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="income" class="required">الدخل الشهري (جنيه):</label>
                        <input type="number" id="income" min="0" required placeholder="أدخل إجمالي الدخل الشهري">
                    </div>
                    
                    <div class="form-group">
                        <label for="expenses" class="required">المصروفات الشهرية (جنيه):</label>
                        <input type="number" id="expenses" min="0" required placeholder="أدخل إجمالي المصروفات الشهرية">
                    </div>
                </div>
                
                <div class="form-section">
                    <h2><i class="fas fa-couch"></i> الأجهزة المتوفرة حالياً</h2>
                    
                    <div class="device-card">
                        <h3><i class="fas fa-bed"></i> الأسرة والمراتب</h3>
                        
                        <div class="device-count">
                            <div>
                                <label for="bedsCount">عدد السرير المتوفرة:</label>
                                <input type="number" id="bedsCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedBedsCount">عدد التالف منها:</label>
                                <input type="number" id="damagedBedsCount" min="0" value="0">
                            </div>
                        </div>
                        
                        <div class="device-count">
                            <div>
                                <label for="mattressesCount">عدد المراتب المتوفرة:</label>
                                <input type="number" id="mattressesCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedMattressesCount">عدد التالف منها:</label>
                                <input type="number" id="damagedMattressesCount" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <h3><i class="fas fa-utensils"></i> أجهزة المطبخ</h3>
                        
                        <div class="device-count">
                            <div>
                                <label for="stovesCount">عدد البوتجاز المتوفرة:</label>
                                <input type="number" id="stovesCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedStovesCount">عدد التالف منها:</label>
                                <input type="number" id="damagedStovesCount" min="0" value="0">
                            </div>
                        </div>
                        
                        <div id="stoveDamageTypeGroup" class="damage-type-group" style="display: none;">
                            <label for="stoveDamageType">نوع تلف البوتجاز:</label>
                            <select id="stoveDamageType" onchange="toggleStoveOther(this)">
                                <option value="بيهب">بيهب</option>
                                <option value="بيسرب غاز">بيسرب غاز</option>
                                <option value="برومة">برومة</option>
                                <option value="غير ذلك">غير ذلك</option>
                            </select>
                            <div id="stoveOther" class="other-input" style="display: none;">
                                <input type="text" placeholder="حدد نوع التلف">
                            </div>
                        </div>
                        
                        <div id="stoveRepairAttemptGroup" class="damage-type-group" style="display: none;">
                            <label>هل تم محاولة إصلاحه من قبل؟</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="stoveRepairAttempt" value="yes" id="stoveRepairYes">
                                    <label for="stoveRepairYes">نعم</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="stoveRepairAttempt" value="no" id="stoveRepairNo" checked>
                                    <label for="stoveRepairNo">لا</label>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div class="request-item">
                                <input type="checkbox" id="hasOven">
                                <label for="hasOven"><i class="fas fa-fire"></i> لديهم فرن</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <h3><i class="fas fa-washing-machine"></i> الغسالات</h3>
                        
                        <div class="device-count">
                            <div>
                                <label for="washersCount">عدد الغسالات العادية المتوفرة:</label>
                                <input type="number" id="washersCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedWashersCount">عدد التالف منها:</label>
                                <input type="number" id="damagedWashersCount" min="0" value="0">
                            </div>
                        </div>
                        
                        <div id="washerDamageTypeGroup" class="damage-type-group" style="display: none;">
                            <label for="washerDamageType">نوع تلف الغسالة العادية:</label>
                            <select id="washerDamageType" onchange="toggleWasherOther(this)">
                                <option value="موتور">موتور</option>
                                <option value="برومة">برومة</option>
                                <option value="عصر">عصر</option>
                                <option value="مروحة">مروحة</option>
                                <option value="غير ذلك">غير ذلك</option>
                            </select>
                            <div id="washerOther" class="other-input" style="display: none;">
                                <input type="text" placeholder="حدد نوع التلف">
                            </div>
                        </div>
                        
                        <div id="washerRepairAttemptGroup" class="damage-type-group" style="display: none;">
                            <label>هل تم محاولة إصلاحه من قبل؟</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="washerRepairAttempt" value="yes" id="washerRepairYes">
                                    <label for="washerRepairYes">نعم</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="washerRepairAttempt" value="no" id="washerRepairNo" checked>
                                    <label for="washerRepairNo">لا</label>
                                </div>
                            </div>
                        </div>

                        <div class="device-count">
                            <div>
                                <label for="halfWashersCount">عدد الغسالات هاف المتوفرة:</label>
                                <input type="number" id="halfWashersCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedHalfWashersCount">عدد التالف منها:</label>
                                <input type="number" id="damagedHalfWashersCount" min="0" value="0">
                            </div>
                        </div>
                        
                        <div id="halfWasherDamageTypeGroup" class="damage-type-group" style="display: none;">
                            <label for="halfWasherDamageType">نوع تلف الغسالة الهاف:</label>
                            <select id="halfWasherDamageType" onchange="toggleHalfWasherOther(this)">
                                <option value="موتور">موتور</option>
                                <option value="برومة">برومة</option>
                                <option value="عصر">عصر</option>
                                <option value="مروحة">مروحة</option>
                                <option value="غير ذلك">غير ذلك</option>
                            </select>
                            <div id="halfWasherOther" class="other-input" style="display: none;">
                                <input type="text" placeholder="حدد نوع التلف">
                            </div>
                        </div>
                        
                        <div id="halfWasherRepairAttemptGroup" class="damage-type-group" style="display: none;">
                            <label>هل تم محاولة إصلاحه من قبل؟</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="halfWasherRepairAttempt" value="yes" id="halfWasherRepairYes">
                                    <label for="halfWasherRepairYes">نعم</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="halfWasherRepairAttempt" value="no" id="halfWasherRepairNo" checked>
                                    <label for="halfWasherRepairNo">لا</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="device-card">
                        <h3><i class="fas fa-snowflake"></i> الثلاجات</h3>
                        
                        <div class="device-count">
                            <div>
                                <label for="fridgesCount">عدد الثلاجات المتوفرة:</label>
                                <input type="number" id="fridgesCount" min="0" value="0">
                            </div>
                            <div>
                                <label for="damagedFridgesCount">عدد التالف منها:</label>
                                <input type="number" id="damagedFridgesCount" min="0" value="0">
                            </div>
                        </div>
                        
                        <div id="fridgeDamageTypeGroup" class="damage-type-group" style="display: none;">
                            <label for="fridgeDamageType">نوع تلف الثلاجة:</label>
                            <select id="fridgeDamageType" onchange="toggleFridgeOther(this)">
                                <option value="موتور">موتور</option>
                                <option value="برومة">برومة</option>
                                <option value="باب الثلاجة مكسور">باب الثلاجة مكسور</option>
                                <option value="غير ذلك">غير ذلك</option>
                            </select>
                            <div id="fridgeOther" class="other-input" style="display: none;">
                                <input type="text" placeholder="حدد نوع التلف">
                            </div>
                        </div>
                        
                        <div id="fridgeRepairAttemptGroup" class="damage-type-group" style="display: none;">
                            <label>هل تم محاولة إصلاحه من قبل؟</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="fridgeRepairAttempt" value="yes" id="fridgeRepairYes">
                                    <label for="fridgeRepairYes">نعم</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="fridgeRepairAttempt" value="no" id="fridgeRepairNo" checked>
                                    <label for="fridgeRepairNo">لا</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2><i class="fas fa-hands-helping"></i> الطلبات والاحتياجات</h2>
                    
                    <div class="form-group">
                        <label>الطلبات على لسان الأسرة:</label>
                        <div class="requests-group">
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="ثلاجة" id="requestFridge">
                                <label for="requestFridge"><i class="fas fa-snowflake"></i> ثلاجة</label>
                            </div>
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="غسالة" id="requestWasher">
                                <label for="requestWasher"><i class="fas fa-washing-machine"></i> غسالة</label>
                            </div>
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="بوتجاز" id="requestStove">
                                <label for="requestStove"><i class="fas fa-fire"></i> بوتجاز</label>
                            </div>
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="سرير" id="requestBed">
                                <label for="requestBed"><i class="fas fa-bed"></i> سرير</label>
                            </div>
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="مرتبة" id="requestMattress">
                                <label for="requestMattress"><i class="fas fa-bed"></i> مرتبة</label>
                            </div>
                            <div class="request-item">
                                <input type="checkbox" name="requests" value="غير ذلك" id="requestOther" onchange="toggleOtherRequest(this)">
                                <label for="requestOther"><i class="fas fa-ellipsis-h"></i> غير ذلك</label>
                            </div>
                        </div>
                        <div id="otherRequest" class="other-input" style="display: none;">
                            <input type="text" placeholder="حدد الطلب الآخر">
                        </div>
                    </div>
                    
                    <div class="form-group" id="medicalConditionsGroup" style="display:none;">
                        <label>هل يوجد أفراد بحاجة لحفظ أدوية (مريض سكر يحتاج أنسولين، أمراض كبد، إلخ)؟</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="medicalConditions" value="yes" id="medicalYes">
                                <label for="medicalYes">نعم</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="medicalConditions" value="no" id="medicalNo" checked>
                                <label for="medicalNo">لا</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="smallApartmentGroup" style="display:none;">
                        <label>هل الشقة صغيرة ولا يوجد مكان كافي للأثاث؟</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="smallApartment" value="yes" id="apartmentYes">
                                <label for="apartmentYes">نعم</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="smallApartment" value="no" id="apartmentNo" checked>
                                <label for="apartmentNo">لا</label>
                            </div>
                        </div>
                    </div>           
                </div>
                
                <div id="purchasedItemsGroup" class="form-group">
                    <label for="purchasedItems">ما تم شراؤه بالفعل:</label>
                    <textarea id="purchasedItems" rows="3" placeholder="أدخل الأغراض التي تم شراؤها مسبقاً"></textarea>
                </div>
                
                <div class="notes-section">
                    <h2><i class="fas fa-sticky-note"></i> لينك الاستكشاف</h2>
                    <div class="form-group">
                        
                        <textarea id="notes" rows="4" placeholder="ارفع ورقة الاستكشاف على درايف وحط اللينك هنا"></textarea>
                    </div>
                </div>
               
                <button type="button" onclick="evaluateFamily()">
                    <i class="fas fa-calculator"></i> تقييم الاستحقاق
                </button>
            </form>
            
            <div id="result" class="result-container">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-clipboard-check"></i> نتيجة التقييم
                    </div>
                    <div id="ratingBadge" class="rating-badge A">A</div>
                </div>
                
                <div id="eligibilityStatus" class="eligibility-status eligible">
                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem;"></i>
                    <div>
                        <p id="eligibilityText"></p>
                        <p id="additionalNotes" style="margin-top: 10px; font-size: 0.95rem;"></p>
                    </div>
                </div>
                
                <div class="visual-rating">
                    <div id="ratingCircle" class="rating-circle A">
                        <div class="letter">A</div>
                        <div class="text">ممتاز</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar" style="width: 90%"></div>
                </div>
                <div class="progress-labels">
                    <span>أقل احتياج</span>
                    <span>أكثر احتياج</span>
                </div>
                
                <div id="washerCondition" class="condition-box">
                    <div class="condition-title">
                        <i class="fas fa-washing-machine"></i>
                        <span>شروط الحصول على غسالة</span>
                    </div>
                    <div id="washerConditionText" class="condition-desc"></div>
                </div>
                
                <div id="fridgeCondition" class="fridge-condition">
                    <div class="condition-title">
                        <i class="fas fa-snowflake"></i>
                        <span>شروط الحصول على ثلاجة</span>
                    </div>
                    <div id="fridgeConditionText" class="condition-desc"></div>
                </div>
                
                <div id="brideRules" class="bride-rules">
                    <h4><i class="fas fa-ring"></i> قواعد خاصة للعرايس</h4>
                    <div id="brideRulesText"></div>
                </div>
                
                <div id="devicesNeeded" class="devices-list"></div>
            </div>
        </div>
    </div>

<div id="saveMessage">
        <i class="fas fa-check-circle"></i> تم حفظ بيانات المستخدم بنجاح في جدول البيانات
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="launched-by">
                <i class="fas fa-rocket"></i>
               Launched by: Khalifa
            </div>
            <div class="signature">نظام تقييم استحقاق المساعدات</div>
            <div class="version">Version 1.2 | 13/7/2025</div> 
        </div>
    </footer>
    <script>
        // متغيرات الخريطة
        let map;
        let currentMarker;
        let selectedLocation = null;

        // تهيئة الخريطة
        function initMap() {
            // إحداثيات القاهرة كنقطة بداية
            const defaultLocation = [30.0444, 31.2357];
            
            map = L.map('map').setView(defaultLocation, 10);
            
            // إضافة طبقة الخريطة من OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // إضافة مستمع للنقر على الخريطة
            map.on('click', function(e) {
                setLocationMarker(e.latlng.lat, e.latlng.lng);
            });
        }

        // تعيين علامة الموقع
        function setLocationMarker(lat, lng) {
            // إزالة العلامة السابقة إن وجدت
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // إضافة علامة جديدة
            currentMarker = L.marker([lat, lng]).addTo(map);
            
            // حفظ الموقع المحدد
            selectedLocation = { lat: lat, lng: lng };
            
            // تحديث الحقول المخفية
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // الحصول على العنوان من الإحداثيات
            getAddressFromCoordinates(lat, lng);
            
            // إظهار معلومات الموقع
            updateLocationInfo(lat, lng);
        }

        // الحصول على العنوان من الإحداثيات
        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`);
                const data = await response.json();
                
                if (data && data.display_name) {
                    const address = data.display_name;
                    document.getElementById('fullAddress').value = address;
                    document.getElementById('selectedAddress').textContent = address;
                } else {
                    document.getElementById('selectedAddress').textContent = 'لم يتم العثور على العنوان';
                }
            } catch (error) {
                console.error('خطأ في الحصول على العنوان:', error);
                document.getElementById('selectedAddress').textContent = 'خطأ في تحديد العنوان';
            }
        }

        // تحديث معلومات الموقع
        function updateLocationInfo(lat, lng) {
            document.getElementById('selectedCoordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('locationInfo').style.display = 'block';
        }

        // البحث عن موقع
        async function searchLocation() {
            const searchTerm = document.getElementById('locationSearch').value.trim();
            
            if (!searchTerm) {
                alert('يرجى إدخال اسم المكان للبحث');
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&accept-language=ar&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const location = data[0];
                    const lat = parseFloat(location.lat);
                    const lng = parseFloat(location.lon);
                    
                    // تحريك الخريطة إلى الموقع المعثور عليه
                    map.setView([lat, lng], 15);
                    
                    // تعيين العلامة
                    setLocationMarker(lat, lng);
                } else {
                    alert('لم يتم العثور على الموقع المطلوب');
                }
            } catch (error) {
                console.error('خطأ في البحث:', error);
                alert('حدث خطأ أثناء البحث');
            }
        }

        // الحصول على الموقع الحالي
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // تحريك الخريطة إلى الموقع الحالي
                        map.setView([lat, lng], 15);
                        
                        // تعيين العلامة
                        setLocationMarker(lat, lng);
                    },
                    function(error) {
                        console.error('خطأ في تحديد الموقع:', error);
                        alert('لم يتم السماح بالوصول إلى الموقع أو حدث خطأ');
                    }
                );
            } else {
                alert('المتصفح لا يدعم تحديد الموقع الجغرافي');
            }
        }

        // إعادة تعيين الخريطة
        function resetMap() {
            // إزالة العلامة
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            
            // إعادة تعيين المتغيرات
            selectedLocation = null;
            
            // مسح الحقول
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('fullAddress').value = '';
            document.getElementById('locationSearch').value = '';
            
            // إخفاء معلومات الموقع
            document.getElementById('locationInfo').style.display = 'none';
            
            // العودة إلى الموقع الافتراضي
            map.setView([30.0444, 31.2357], 10);
        }

        // تهيئة الخريطة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });

        // إضافة مستمع للبحث عند الضغط على Enter
        document.getElementById('locationSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });

        // متغيرات لتخزين نتيجة التقييم
        let currentRating = '';
        let currentEligibility = '';
        let currentApprovedDevices = [];
        let currentAdditionalNotes = '';
        
function collectFormData() {
            const formData = {
                timestamp: new Date().toLocaleString('ar-EG'),
                familyType: document.getElementById('familyType').value,
                familyName: document.getElementById('familyName').value,
                nationalId: document.getElementById('nationalId').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                familySize: document.getElementById('familySize').value,
                income: document.getElementById('income').value,
                expenses: document.getElementById('expenses').value,
                notes: document.getElementById('notes').value,
                purchasedItems: document.getElementById('purchasedItems').value,
                
                // إضافة بيانات الموقع
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                fullAddress: document.getElementById('fullAddress').value,
                
                // جمع بيانات الأجهزة
                bedsCount: document.getElementById('bedsCount').value,
                damagedBedsCount: document.getElementById('damagedBedsCount').value,
                mattressesCount: document.getElementById('mattressesCount').value,
                damagedMattressesCount: document.getElementById('damagedMattressesCount').value,
                stovesCount: document.getElementById('stovesCount').value,
                damagedStovesCount: document.getElementById('damagedStovesCount').value,
                hasOven: document.getElementById('hasOven').checked,
                washersCount: document.getElementById('washersCount').value,
                damagedWashersCount: document.getElementById('damagedWashersCount').value,
                halfWashersCount: document.getElementById('halfWashersCount').value,
                damagedHalfWashersCount: document.getElementById('damagedHalfWashersCount').value,
                fridgesCount: document.getElementById('fridgesCount').value,
                damagedFridgesCount: document.getElementById('damagedFridgesCount').value,
                
                // جمع الطلبات
                requests: Array.from(document.querySelectorAll('input[name="requests"]:checked'))
                    .map(checkbox => checkbox.nextElementSibling.textContent),
                
                // جمع الإجابات على الأسئلة
                hasProvider: document.querySelector('input[name="hasProvider"]:checked')?.value,
                hasElderly: document.querySelector('input[name="hasElderly"]:checked')?.value,
                medicalConditions: document.querySelector('input[name="medicalConditions"]:checked')?.value,
                smallApartment: document.querySelector('input[name="smallApartment"]:checked')?.value,
                
                // جمع أفراد الأسرة
                familyMembers: [],
                
                // إضافة نتيجة التقييم
                rating: currentRating,
                eligibility: currentEligibility,
                approvedDevices: currentApprovedDevices.join(', '),
                additionalNotes: currentAdditionalNotes
            };
            
            // جمع أفراد الأسرة
            const familySize = parseInt(formData.familySize);
            for (let i = 1; i <= familySize; i++) {
                const name = document.getElementById(`memberName${i}`)?.value;
                const relation = document.getElementById(`memberRelation${i}`)?.value;
                if (name && relation) {
                    formData.familyMembers.push({name, relation});
                }
            }
            
            return formData;
        }
        
        // دالة لحفظ البيانات في جدول بيانات Google
function saveToGoogleSheet() {
            const formData = collectFormData();
            
            // رابط البرنامج النصي لجوجل
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxnNvQxg5CQgTm2u0sFpu7to7aYSNeWyupC5WA299TaoqGw1aLir-t-aQ3leFgO0Pk6/exec';
            
            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(() => {
                // عرض رسالة التأكيد
                const message = document.getElementById('saveMessage');
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('حدث خطأ أثناء الحفظ:', error);
            });
        }
        
        // إضافة مستمع الأحداث للنقر على زر التقييم
        
        document.querySelector('button[type="button"]').addEventListener('click', function() {
            evaluateFamily(); // تنفيذ التقييم
            saveToGoogleSheet(); // حفظ البيانات في جدول البيانات
        });


        
        // إظهار/إخفاء الحقول حسب نوع الأسرة
        document.getElementById('familyType').addEventListener('change', function() {
             
            const familyType = this.value;
            const providerGroup = document.getElementById('providerGroup');
            const purchasedItemsGroup = document.getElementById('purchasedItemsGroup');
            const medicalConditionsGroup = document.getElementById('medicalConditionsGroup');
            const smallApartmentGroup = document.getElementById('smallApartmentGroup');
            const elderlyGroup = document.getElementById('elderlyGroup');
            
            // إظهار حقل العائل وما تم شراؤه للعروسة فقط
            if (familyType === 'engaged' || familyType === 'married') {
                providerGroup.style.display = 'block';
                purchasedItemsGroup.style.display = 'block';
            } else {
                providerGroup.style.display = 'none';
                purchasedItemsGroup.style.display = 'none';
            }
            
            if (familyType === 'family') {
                medicalConditionsGroup.style.display = 'block';
                smallApartmentGroup.style.display = 'block';
                elderlyGroup.style.display = 'block';
            } else {
                medicalConditionsGroup.style.display = 'none';
                smallApartmentGroup.style.display = 'none';
                elderlyGroup.style.display = 'none';
            }
            generateFamilyMembersInputs();
        });
        
        // إظهار/إخفاء نوع تلف البوتجاز ومحاولة الإصلاح عند إدخال عدد التالف
        document.getElementById('damagedStovesCount').addEventListener('input', function() {
            const damageTypeGroup = document.getElementById('stoveDamageTypeGroup');
            const repairGroup = document.getElementById('stoveRepairAttemptGroup');
            if (this.value > 0) {
                damageTypeGroup.style.display = 'block';
                repairGroup.style.display = 'block';
            } else {
                damageTypeGroup.style.display = 'none';
                repairGroup.style.display = 'none';
            }
        });
        
        // إظهار/إخفاء نوع تلف الغسالة العادية ومحاولة الإصلاح
        document.getElementById('damagedWashersCount').addEventListener('input', function() {
            const damageTypeGroup = document.getElementById('washerDamageTypeGroup');
            const repairGroup = document.getElementById('washerRepairAttemptGroup');
            if (this.value > 0) {
                damageTypeGroup.style.display = 'block';
                repairGroup.style.display = 'block';
            } else {
                damageTypeGroup.style.display = 'none';
                repairGroup.style.display = 'none';
            }
        });
        
        // إظهار/إخفاء نوع تلف الغسالة الهاف ومحاولة الإصلاح
        document.getElementById('damagedHalfWashersCount').addEventListener('input', function() {
            const damageTypeGroup = document.getElementById('halfWasherDamageTypeGroup');
            const repairGroup = document.getElementById('halfWasherRepairAttemptGroup');
            if (this.value > 0) {
                damageTypeGroup.style.display = 'block';
                repairGroup.style.display = 'block';
            } else {
                damageTypeGroup.style.display = 'none';
                repairGroup.style.display = 'none';
            }
        });
        
        // إظهار/إخفاء نوع تلف الثلاجة ومحاولة الإصلاح
        document.getElementById('damagedFridgesCount').addEventListener('input', function() {
            const damageTypeGroup = document.getElementById('fridgeDamageTypeGroup');
            const repairGroup = document.getElementById('fridgeRepairAttemptGroup');
            if (this.value > 0) {
                damageTypeGroup.style.display = 'block';
                repairGroup.style.display = 'block';
            } else {
                damageTypeGroup.style.display = 'none';
                repairGroup.style.display = 'none';
            }
        });

// دالة لإنشاء حقول إدخال لأفراد الأسرة
function generateFamilyMembersInputs() {
    const familySize = parseInt(document.getElementById('familySize').value);
    const container = document.getElementById('familyMembersContainer');
    const familyType = document.getElementById('familyType').value;
    container.innerHTML = '';
    
    // إظهار القسم فقط إذا كان نوع الأسرة "أسرة"
    if (familySize > 0) {
        document.getElementById('familyMembersGroup').style.display = 'block';
        
        for (let i = 1; i <= familySize; i++) {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'form-row';
            memberDiv.style.marginBottom = '15px';
            memberDiv.style.padding = '10px';
            memberDiv.style.backgroundColor = '#f8f9fa';
            memberDiv.style.borderRadius = '8px';
            
            memberDiv.innerHTML = `
                <div class="form-col">
                    <label for="memberName${i}">اسم العضو ${i}:</label>
                    <input type="text" id="memberName${i}" placeholder="أدخل اسم العضو ${i}" required>
                </div>
                <div class="form-col">
                    <label for="memberRelation${i}">صلة القرابة:</label>
                    <select id="memberRelation${i}" required>
                        <option value="">-- اختر القرابة --</option>
                        <option value="الحالة">الحالة</option>
                        <option value="أب">أب</option>
                        <option value="أم">أم</option>
                        <option value="ابن">ابن</option>
                        <option value="ابنة">ابنة</option>
                        <option value="جد">جد</option>
                        <option value="جدة">جدة</option>
                        <option value="عم">عم</option>
                        <option value="عمة">عمة</option>
                        <option value="خال">خال</option>
                        <option value="خالة">خالة</option>
                        <option value="أخ">أخ</option>
                        <option value="أخت">أخت</option>
                        <option value="زوج">زوج</option>
                        <option value="زوجة">زوجة</option>
                        <option value="ابن اخ">ابن اخ</option>
                        <option value="ابن اخت">ابن اخت</option>
                        <option value="ابن خال">ابن خال</option>
                        <option value="ابن خالة">ابن خالة</option>
                        <option value="ابن عم">ابن عم</option>
                        <option value="ابن عمة">ابن عمة</option>
                        <option value="غير ذلك">غير ذلك</option>
                    </select>
                </div>
            `;
            container.appendChild(memberDiv);
        }
    } else {
        document.getElementById('familyMembersGroup').style.display = 'none';
    }
}



        
        // إدارة الحقول الإضافية عند اختيار "غير ذلك" للبوتجاز
        function toggleStoveOther(select) {
            const otherInput = document.getElementById('stoveOther');
            otherInput.style.display = select.value === 'غير ذلك' ? 'block' : 'none';
            if(select.value !== 'غير ذلك') otherInput.querySelector('input').value = '';
        }
        
        // إدارة الحقول الإضافية عند اختيار "غير ذلك" للغسالة العادية
        function toggleWasherOther(select) {
            const otherInput = document.getElementById('washerOther');
            otherInput.style.display = select.value === 'غير ذلك' ? 'block' : 'none';
            if(select.value !== 'غير ذلك') otherInput.querySelector('input').value = '';
        }
        
        // إدارة الحقول الإضافية عند اختيار "غير ذلك" للغسالة الهاف
        function toggleHalfWasherOther(select) {
            const otherInput = document.getElementById('halfWasherOther');
            otherInput.style.display = select.value === 'غير ذلك' ? 'block' : 'none';
            if(select.value !== 'غير ذلك') otherInput.querySelector('input').value = '';
        }
        
        // إدارة الحقول الإضافية عند اختيار "غير ذلك" للثلاجة
        function toggleFridgeOther(select) {
            const otherInput = document.getElementById('fridgeOther');
            otherInput.style.display = select.value === 'غير ذلك' ? 'block' : 'none';
            if(select.value !== 'غير ذلك') otherInput.querySelector('input').value = '';
        }
        
        // إدارة الحقل الإضافي لطلب "غير ذلك"
        function toggleOtherRequest(checkbox) {
            const otherInput = document.getElementById('otherRequest');
            otherInput.style.display = checkbox.checked ? 'block' : 'none';
            if (!checkbox.checked) otherInput.querySelector('input').value = '';
        }
        
        // دالة تقييم الأسرة
        function evaluateFamily() {
            // جمع البيانات الأساسية
            const familyType = document.getElementById('familyType').value;
            const familyName = document.getElementById('familyName').value;
            const nationalId = document.getElementById('nationalId').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const familySize = parseInt(document.getElementById('familySize').value);
            const income = parseFloat(document.getElementById('income').value);
            const expenses = parseFloat(document.getElementById('expenses').value);
            const notes = document.getElementById('notes').value;
            const hasElderly = document.querySelector('input[name="hasElderly"]:checked')?.value === 'yes';
            const hasProvider = document.querySelector('input[name="hasProvider"]:checked')?.value === 'yes';

            // جمع بيانات الأجهزة
            const bedsCount = parseInt(document.getElementById('bedsCount').value);
            const damagedBedsCount = parseInt(document.getElementById('damagedBedsCount').value);
            const mattressesCount = parseInt(document.getElementById('mattressesCount').value);
            const damagedMattressesCount = parseInt(document.getElementById('damagedMattressesCount').value);
            const stovesCount = parseInt(document.getElementById('stovesCount').value);
            const damagedStovesCount = parseInt(document.getElementById('damagedStovesCount').value);
            const stoveDamageType =
                damagedStovesCount > 0
                    ? document.getElementById('stoveDamageType').value === 'غير ذلك'
                        ? document.getElementById('stoveOther').querySelector('input').value
                        : document.getElementById('stoveDamageType').value
                    : '';
            const hasOven = document.getElementById('hasOven').checked;
            const washersCount = parseInt(document.getElementById('washersCount').value);
            const damagedWashersCount = parseInt(document.getElementById('damagedWashersCount').value);
            const washerDamageType =
                damagedWashersCount > 0
                    ? document.getElementById('washerDamageType').value === 'غير ذلك'
                        ? document.getElementById('washerOther').querySelector('input').value
                        : document.getElementById('washerDamageType').value
                    : '';
            const halfWashersCount = parseInt(document.getElementById('halfWashersCount').value);
            const damagedHalfWashersCount = parseInt(document.getElementById('damagedHalfWashersCount').value);
            const halfWasherDamageType =
                damagedHalfWashersCount > 0
                    ? document.getElementById('halfWasherDamageType').value === 'غير ذلك'
                        ? document.getElementById('halfWasherOther').querySelector('input').value
                        : document.getElementById('halfWasherDamageType').value
                    : '';
            const fridgesCount = parseInt(document.getElementById('fridgesCount').value);
            const damagedFridgesCount = parseInt(document.getElementById('damagedFridgesCount').value);
            const fridgeDamageType =
                damagedFridgesCount > 0
                    ? document.getElementById('fridgeDamageType').value === 'غير ذلك'
                        ? document.getElementById('fridgeOther').querySelector('input').value
                        : document.getElementById('fridgeDamageType').value
                    : '';
            
            // جمع إجابات محاولة الإصلاح
            const stoveRepairAttempt = document.querySelector('input[name="stoveRepairAttempt"]:checked')?.value;
            const washerRepairAttempt = document.querySelector('input[name="washerRepairAttempt"]:checked')?.value;
            const halfWasherRepairAttempt = document.querySelector('input[name="halfWasherRepairAttempt"]:checked')?.value;
            const fridgeRepairAttempt = document.querySelector('input[name="fridgeRepairAttempt"]:checked')?.value;
            
            // جمع الطلبات مع العلم أنها قد تكون مخصصة
            let requests = Array.from(document.querySelectorAll('input[name="requests"]:checked'))
                .map(checkbox => {
                    if (checkbox.value === 'غير ذلك') {
                        const value = document.getElementById('otherRequest').querySelector('input').value.trim();
                        return { value, isCustom: true };
                    } else {
                        return { value: checkbox.value, isCustom: false };
                    }
                })
                .filter(request => request.value !== ''); // تجاهل الطلبات الفارغة

            // تحديد الأجهزة المطلوبة
            const neededDevices = [];
            const addedDevices = new Set();
            let additionalNotes = '';
            let brideRules = '';
            
            // تطبيق القواعد الخاصة للعروسات المكتوب كتابهن
            if (familyType === 'married') {
                brideRules = '<p>القواعد المطبقة للعروسة:</p><ul>';
                
                // تحديد الطلبات المحددة
                const hasFridgeRequest = requests.some(req => req.value === 'ثلاجة');
                const hasWasherRequest = requests.some(req => req.value === 'غسالة');
                const hasStoveRequest = requests.some(req => req.value === 'بوتجاز');
                
                // الحالة 1: طلبت غسالة وثلاجة وبوتجاز
                if (hasFridgeRequest && hasWasherRequest && hasStoveRequest) {
                    neededDevices.push('غسالة هاف');
                    neededDevices.push('بوتجاز');
                    addedDevices.add('غسالة هاف');
                    addedDevices.add('بوتجاز');
                    brideRules += '<li>ناجح في (غسالة هاف وبوتجاز) بسبب طلب غسالة وثلاجة وبوتجاز</li>';
                    
                    // إزالة هذه الطلبات من القائمة
                    requests = requests.filter(req => 
                        req.value !== 'ثلاجة' && 
                        req.value !== 'غسالة' && 
                        req.value !== 'بوتجاز'
                    );
                }
                // الحالة 2: طلبت بوتجاز فقط أو غسالة فقط
                else if ((hasStoveRequest && !hasWasherRequest && !hasFridgeRequest) || 
                         (hasWasherRequest && !hasStoveRequest && !hasFridgeRequest)) {
                    if (hasStoveRequest) {
                        neededDevices.push('بوتجاز 5 شعلة');
                        addedDevices.add('بوتجاز 5 شعلة');
                        brideRules += '<li>ناجح في بوتجاز 5 شعلة بسبب طلب بوتجاز فقط</li>';
                        requests = requests.filter(req => req.value !== 'بوتجاز');
                    }
                    if (hasWasherRequest) {
                        neededDevices.push('غسالة هاف');
                        addedDevices.add('غسالة هاف');
                        brideRules += '<li>ناجح في غسالة هاف بسبب طلب غسالة فقط</li>';
                        requests = requests.filter(req => req.value !== 'غسالة');
                    }
                }
                // الحالة 3: طلبت بوتجاز وغسالة معاً
                else if (hasStoveRequest && hasWasherRequest && !hasFridgeRequest) {
                    neededDevices.push('غسالة هاف');
                    neededDevices.push('بوتجاز 5 شعلة');
                    addedDevices.add('غسالة هاف');
                    addedDevices.add('بوتجاز 5 شعلة');
                    brideRules += '<li>ناجح في (غسالة هاف وبوتجاز 5 شعلة) بسبب طلب بوتجاز وغسالة معاً</li>';
                    requests = requests.filter(req => req.value !== 'بوتجاز' && req.value !== 'غسالة');
                }
                // الحالة 4: طلبت ثلاجة فقط
                else if (hasFridgeRequest && !hasWasherRequest && !hasStoveRequest) {
                    if (!hasProvider) {
                        neededDevices.push('ثلاجة');
                        addedDevices.add('ثلاجة');
                        brideRules += '<li>ناجح في ثلاجة بسبب عدم وجود عائل</li>';
                    } else {
                        brideRules += '<li>غير ناجح في ثلاجة بسبب وجود عائل</li>';
                    }
                    requests = requests.filter(req => req.value !== 'ثلاجة');
                }
                // الحالة 5: طلبت غسالة وثلاجة
                else if (hasWasherRequest && hasFridgeRequest && !hasStoveRequest) {
                    if (!hasProvider) {
                        neededDevices.push('غسالة هاف');
                        neededDevices.push('ثلاجة');
                        addedDevices.add('غسالة هاف');
                        addedDevices.add('ثلاجة');
                        brideRules += '<li>ناجح في (غسالة هاف وثلاجة) بسبب عدم وجود عائل</li>';
                    } else {
                        neededDevices.push('غسالة هاف');
                        addedDevices.add('غسالة هاف');
                        brideRules += '<li>ناجح في غسالة هاف فقط بسبب وجود عائل</li>';
                    }
                    requests = requests.filter(req => req.value !== 'غسالة' && req.value !== 'ثلاجة');
                }
                // الحالة 6: طلبت بوتجاز وثلاجة
                else if (hasStoveRequest && hasFridgeRequest && !hasWasherRequest) {
                    if (!hasProvider) {
                        neededDevices.push('بوتجاز');
                        neededDevices.push('ثلاجة');
                        addedDevices.add('بوتجاز');
                        addedDevices.add('ثلاجة');
                        brideRules += '<li>ناجح في (بوتجاز وثلاجة) بسبب عدم وجود عائل</li>';
                    } else {
                        neededDevices.push('بوتجاز');
                        addedDevices.add('بوتجاز');
                        brideRules += '<li>ناجح في بوتجاز فقط بسبب وجود عائل</li>';
                    }
                    requests = requests.filter(req => req.value !== 'بوتجاز' && req.value !== 'ثلاجة');
                }
                
                brideRules += '</ul>';
            }

            // التحقق من وجود غسالة عاملة
            const workingFullWashers = washersCount - damagedWashersCount;
            const workingHalfWashers = halfWashersCount - damagedHalfWashersCount;
            const hasWorkingWasher = workingFullWashers > 0 || workingHalfWashers > 0;
            let washerConditionMet = true;
            let washerConditionNote = '';

            // إضافة دعم مالي للعروسة إذا لم يكن لها عائل
            

            // متغيرات خاصة بتقييم الثلاجة
            let fridgeConditionMet = false;
            let fridgeConditionNote = '';
            let fridgeConditionDetails = '';
            
            // معالجة الطلبات المتبقية
            requests.forEach(requestObj => {
                const request = requestObj.value;
                const isCustom = requestObj.isCustom;

                if (isCustom) {
                    if (!addedDevices.has(request)) {
                        neededDevices.push(request);
                        addedDevices.add(request);
                    }
                } else {
                    switch (request) {
                        case 'سرير':
                            // حساب عدد السراير المطلوبة بناءً على عدد الأفراد مقسومًا على 1.5
                            const requiredBeds = Math.ceil(familySize / 2);
                            const workingBeds = bedsCount - damagedBedsCount;
                            const neededBeds = Math.max(0, requiredBeds - workingBeds);
                            
                            if (neededBeds > 0 && !addedDevices.has('سرير')) {
                                neededDevices.push(`سرير (${neededBeds} عدد)`);
                                addedDevices.add('سرير');
                            }
                            break;

                        case 'مرتبة':
                            // حساب عدد المراتب المطلوبة بناءً على عدد الأفراد مقسومًا على 1.5
                            const requiredMattresses = Math.ceil(familySize / 2);
                            const workingMattresses = mattressesCount - damagedMattressesCount;
                            const neededMattresses = Math.max(0, requiredMattresses - workingMattresses);
                            
                            if (neededMattresses > 0 && !addedDevices.has('مرتبة')) {
                                neededDevices.push(`مرتبة (${neededMattresses} عدد)`);
                                addedDevices.add('مرتبة');
                            }
                            break;

                        case 'بوتجاز':
                            // التحقق من محاولة الإصلاح للبوتجاز التالف
                            if (damagedStovesCount > 0 && stoveRepairAttempt === 'no') {
                                additionalNotes += "لم يتم إضافة بوتجاز بسبب وجود جهاز تالف لم تتم محاولة إصلاحه. ";
                                break;
                            }
                            
                            // التحقق من شروط البوتجاز للأسرة
                            if (familyType === 'family') {
                                if (familySize < 3) {
                                    additionalNotes += "عذراً، طلب البوتجاز غير مؤهل لأن عدد أفراد الأسرة أقل من 3. ";
                                    break;
                                }
                            }
                            
                            // التحقق من وجود بوتجاز عامل أو فرن
                            const hasWorkingStove = (stovesCount - damagedStovesCount) > 0;
                            if (hasWorkingStove) {
                                additionalNotes += "لم يتم إضافة بوتجاز لأن الأسرة تملك بوتجازاً يعمل. ";
                                break;
                            }
                            if (hasOven) {
                                additionalNotes += "لم يتم إضافة بوتجاز لأن الأسرة تملك فرناً. ";
                                break;
                            }

                            if (!addedDevices.has(request)) {
                                neededDevices.push(request);
                                addedDevices.add(request);
                            }
                            break;

                        case 'غسالة':
                            // الشرط: إذا كانت الأسرة لديها غسالة عاملة (عادية أو هاف)
                            if (hasWorkingWasher) {
                                additionalNotes += "لم يتم إضافة غسالة لأن الأسرة تمتلك غسالة عادية أو هاف تعمل. ";
                                washerConditionMet = false;
                                washerConditionNote = "تمتلك الأسرة غسالة عاملة";
                                break;
                            }
                            
                            // التحقق من محاولة الإصلاح للغسالة التالفة
                            if (damagedWashersCount > 0 && washerRepairAttempt === 'no') {
                                additionalNotes += "لم يتم إضافة غسالة بسبب وجود جهاز تالف لم تتم محاولة إصلاحه. ";
                                washerConditionMet = false;
                                washerConditionNote = "وجود غسالة تالفة لم تتم محاولة إصلاحها";
                                break;
                            }
                            
                            // التحقق من محاولة الإصلاح للغسالة الهاف التالفة
                            if (damagedHalfWashersCount > 0 && halfWasherRepairAttempt === 'no') {
                                additionalNotes += "لم يتم إضافة غسالة بسبب وجود غسالة هاف تالفة لم تتم محاولة إصلاحها. ";
                                washerConditionMet = false;
                                washerConditionNote = "وجود غسالة هاف تالفة لم تتم محاولة إصلاحها";
                                break;
                            }
                            
                            // تحديد نوع الغسالة
                            let washerType = '';
                            if (familySize === 2) {
                                washerType = 'غسالة عادية';
                            } else if (familySize >= 3) {
                                washerType = 'غسالة هاف';
                            } else if (familySize === 1 && hasElderly) {
                                washerType = 'غسالة عادية (لشخص مسن)';
                            }
    
                            // إضافة الغسالة المحددة
                            if (washerType && !addedDevices.has(washerType)) {
                                neededDevices.push(washerType);
                                addedDevices.add(washerType);
                            }
                            break;

                        case 'ثلاجة':
                            // تحديد شروط استحقاق الثلاجة
                            fridgeConditionDetails = '';
                            
                            // الشرط 1: عدد الأسرة 7 أو أكثر
                            const condition1 = familySize >= 7;
                            
                            // الشرط 2: وجود حالات طبية تتطلب ثلاجة
                            const medicalConditions = familyType === 'family' ? 
                                document.querySelector('input[name="medicalConditions"]:checked')?.value : 'no';
                            const condition2 = medicalConditions === 'yes';
                            
                            // حالة الثلاجة الحالية
                            const hasFridge = fridgesCount > 0;
                            const hasWorkingFridge = (fridgesCount - damagedFridgesCount) > 0;
                            const hasDamagedFridge = damagedFridgesCount > 0;
                            
                            // هل تمت محاولة إصلاح الثلاجة التالفة؟
                            const fridgeRepaired = fridgeRepairAttempt === 'yes';
                            
                            // تحقق من شروط استحقاق الثلاجة
                            if (condition1 || condition2) {
                                if (!hasFridge || (hasDamagedFridge && fridgeRepaired)) {
                                    fridgeConditionMet = true;
                                    if (!addedDevices.has(request)) {
                                        neededDevices.push(request);
                                        addedDevices.add(request);
                                    }
                                    
                                    // بناء تفاصيل الشرط
                                    fridgeConditionDetails += '<p>استحقاق الثلاجة بناءً على:</p><ul>';
                                    if (condition1) {
                                        fridgeConditionDetails += `<li>عدد الأسرة (${familySize}) 7 أو أكثر</li>`;
                                    }
                                    if (condition2) {
                                        fridgeConditionDetails += '<li>وجود حالات طبية تتطلب ثلاجة</li>';
                                    }
                                    if (!hasFridge) {
                                        fridgeConditionDetails += '<li>لا يوجد ثلاجة في المنزل مع ضرورة سحب الثلاجة التالف وفي حالة عدم وجودها او رفض سحبها يلغى استحقاق الثلاجة</li>';
                                    }
                                    if (hasDamagedFridge && fridgeRepaired) {
                                        fridgeConditionDetails += '<li>وجود ثلاجة تالفة وتمت محاولة إصلاحها</li>';
                                    }
                                    fridgeConditionDetails += '</ul>';
                                } else {
                                    fridgeConditionDetails += '<p>الأسرة تمتلك ثلاجة عاملة ولا تحتاج إلى ثلاجة جديدة</p>';
                                }
                            } else {
                                fridgeConditionDetails += '<p>لا تنطبق شروط استحقاق الثلاجة:</p><ul>';
                                if (familySize < 7) {
                                    fridgeConditionDetails += `<li>عدد الأسرة (${familySize}) أقل من 7</li>`;
                                }
                                if (medicalConditions !== 'yes') {
                                    fridgeConditionDetails += '<li>لا توجد حالات طبية تتطلب ثلاجة</li>';
                                }
                                if (hasFridge && !hasDamagedFridge) {
                                    fridgeConditionDetails += '<li>الأسرة تمتلك ثلاجة عاملة</li>';
                                }
                                if (hasDamagedFridge && !fridgeRepaired) {
                                    fridgeConditionDetails += '<li>الأسرة تمتلك ثلاجة تالفة ولم تتم محاولة إصلاحها</li>';
                                }
                                fridgeConditionDetails += '</ul>';
                            }
                            break;

                        default:
                            if (!addedDevices.has(request)) {
                                neededDevices.push(request);
                                addedDevices.add(request);
                            }
                            break;
                    }
                }
            });

            // حساب تصنيف الاستحقاق وعرض النتائج
           // حساب تصنيف الاستحقاق وعرض النتائج
            const netIncome = income - expenses;
            let rating = 'C';
            let ratingText = 'منخفض';
            let progressWidth = 30;
            const absNetIncome = Math.abs(netIncome);  // القيمة المطلقة

            if (absNetIncome <= 750) {
                rating = 'A';
                ratingText = 'عالي جداً';
                progressWidth = 90;
                additionalNotes += 'الأسرة في حاجة ماسة للمساعدة . ';
            } else if (absNetIncome <= 1500) {
                rating = 'B';
                ratingText = 'متوسط';
                progressWidth = 60;
                additionalNotes += 'الأسرة في حاجة للمساعدة ولكن ليست في حالة طارئة. ';
            } else {
                additionalNotes += 'الأسرة تقييمها منخفض، يمكن النظر لحالات اكثر استحقاقا ';
            }

            // إضافة الملاحظات الإضافية
            if (notes) {
                
            }

            // عرض النتائج
            const resultDiv = document.getElementById('result');
            const eligibilityStatus = document.getElementById('eligibilityStatus');
            const devicesNeededDiv = document.getElementById('devicesNeeded');
            const ratingBadge = document.getElementById('ratingBadge');
            const ratingCircle = document.getElementById('ratingCircle');
            const progressBar = document.getElementById('progressBar');
            const washerConditionDiv = document.getElementById('washerCondition');
            const fridgeConditionDiv = document.getElementById('fridgeCondition');
            const brideRulesDiv = document.getElementById('brideRules');
            const brideRulesText = document.getElementById('brideRulesText');

            ratingBadge.className = `rating-badge ${rating}`;
            ratingBadge.textContent = rating;
            ratingCircle.className = `rating-circle ${rating}`;
            ratingCircle.querySelector('.letter').textContent = rating;
            ratingCircle.querySelector('.text').textContent = ratingText;
            progressBar.style.width = `${progressWidth}%`;

            // تحديث حالة شرط الغسالة
            if (document.getElementById('requestWasher').checked) {
                washerConditionDiv.style.display = 'block';
    
                if (familySize === 1) {
                    washerConditionDiv.querySelector('.condition-desc').innerHTML = `
                        <p>لا تستحق الأسرة غسالة إلا إذا كان الفرد مسنًا</p>
                        <p><strong>عدد الأفراد:</strong> ${familySize}</p>
                        <p><strong>هل يوجد مسن؟</strong> ${hasElderly ? 'نعم' : 'لا'}</p>
                    `;
                } else if (familySize === 2) {
                    washerConditionDiv.querySelector('.condition-desc').innerHTML = `
                        <p>تستحق الأسرة غسالة عادية لأن عدد الأسرة 2</p>
                        <p><strong>عدد الأسرة:</strong> ${familySize}</p>
                    `;
                } else if (familySize >= 3) {
                    washerConditionDiv.querySelector('.condition-desc').innerHTML = `
                        <p>تستحق الأسرة غسالة هاف لأن عدد الأسرة 3 أو أكثر</p>
                        <p><strong>عدد الأسرة:</strong> ${familySize}</p>
                    `;
                }
    
                if (!washerConditionMet) {
                    washerConditionDiv.className = 'condition-box not-met';
                    washerConditionDiv.querySelector('.condition-desc').innerHTML += `<p><strong>سبب عدم الاستحقاق:</strong> ${washerConditionNote}</p>`;
                } else {
                    washerConditionDiv.className = 'condition-box';
                }
            } else {
                washerConditionDiv.style.display = 'none';
            }
            
            // تحديث حالة شرط الثلاجة
            if (document.getElementById('requestFridge').checked) {
                fridgeConditionDiv.style.display = 'block';
                fridgeConditionDiv.querySelector('.condition-desc').innerHTML = fridgeConditionDetails;
                
                if (fridgeConditionMet) {
                    fridgeConditionDiv.className = 'fridge-condition';
                } else {
                    fridgeConditionDiv.className = 'fridge-condition not-met';
                }
            } else {
                fridgeConditionDiv.style.display = 'none';
            }
            
            // تحديث قسم قواعد العروسات
            if (familyType === 'married') {
                brideRulesDiv.style.display = 'block';
                brideRulesText.innerHTML = brideRules;
            } else {
                brideRulesDiv.style.display = 'none';
            }

            let purchasedItemsHTML = '';
            if (purchasedItems) {
                
            }

            if (neededDevices.length > 0) {
                eligibilityStatus.className = 'eligibility-status eligible';
                eligibilityStatus.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.5rem;"></i>
                    <div>
                        <p>الأسرة/العروسة <strong>${familyName}</strong> مؤهلة للحصول على المساعدات.</p>
                        <p style="margin-top: 10px; font-size: 0.95rem;">${additionalNotes}</p>
                    </div>
                `;

                devicesNeededDiv.innerHTML = `
                    <h3><i class="fas fa-box-open"></i> الأجهزة المعتمدة:</h3>
                    ${neededDevices
                        .map(
                            device => `
                        <div class="device-item">
                            <i class="fas fa-check-circle"></i>
                            <span>${device}</span>
                        </div>
                    `
                        )
                        .join('')}
                    ${purchasedItemsHTML}
                `;
            } else {
                eligibilityStatus.className = 'eligibility-status not-eligible';
                eligibilityStatus.innerHTML = `
                    <i class="fas fa-times-circle" style="color: #dc3545; font-size: 1.5rem;"></i>
                    <div>
                        <p>الأسرة/العروسة <strong>${familyName}</strong> غير مؤهلة بناءً على الطلبات المقدمة.</p>
                        <p style="margin-top: 10px; font-size: 0.95rem;">${additionalNotes}</p>
                    </div>
                `;
                devicesNeededDiv.innerHTML = purchasedItemsHTML;
            }

            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
            currentRating = rating;
            currentEligibility = (neededDevices.length > 0) ? 'مؤهل' : 'غير مؤهل';
            currentApprovedDevices = neededDevices;
            currentAdditionalNotes = additionalNotes;
        }
    </script>
</body>
</html>

